select * from "dC"."vPptoServices19";

DROP VIEW "dC"."vPptoServices19";

CREATE OR REPLACE VIEW "dC"."vPptoServices19" AS 
select 
   (select distinct mki.description
      from public.mis_report_kpi_expression mkei
      join mis_report_kpi mki on mki.id=mkei.kpi_id
	  join mis_budget mbi on mbi.report_id=mki.report_id
      where mbi.id=1 and mkei.name not like '%[%' and strpos(mkei.name,mk.name)>0
   ) as pr01, 
   mk.description as pr02, aaa.name as analytic, msk.name as business, 
   to_char(mbi.date_from,'Mon') as month, extract(month from mbi.date_from) monthnbr,
   mbi.amount as budget
   from mis_budget_item mbi
   join account_analytic_account aaa on aaa.id=mbi.analytic_account_id
   join mis_report_kpi_expression mke on mke.id=kpi_expression_id
   join mis_report_kpi mk on mk.id=mke.kpi_id
   left join mis_report_subkpi msk on msk.id=mke.subkpi_id
   where budget_id=1;
   
