select * from "dC"."vEdoResultadosServices2019";

DROP VIEW "dC"."vEdoResultadosServices2019";

CREATE OR REPLACE VIEW "dC"."vEdoResultadosServices2019" AS 
select 
   (select distinct substring(aat.name,5,20) 
      from account_account_tag aat 
      join account_account_account_tag aaat on aaat.account_account_tag_id=aat.id
      where aaat.account_account_id=aa.id and left(aat.name,4)='pr01' limit 1) as pr01,
   (select distinct substring(aat.name,5,20) 
      from account_account_tag aat 
      join account_account_account_tag aaat on aaat.account_account_tag_id=aat.id
      where aaat.account_account_id=aa.id and left(aat.name,4)='pr02' limit 1) as pr02, 
    aaa.name as analytic, 
   (select distinct substring(aat.name,3,3)
      from account_analytic_tag aat 
      join account_analytic_tag_account_move_line_rel aatamlr on aatamlr.account_analytic_tag_id = aat.id
      where aatamlr.account_move_line_id=aml.id and aat.usage='business' and left(aat.name,2)='B:' limit 1) 
      as Business, 
   am.name as move, am.date, aatype.name as type, aa.name as account, aml.credit-aml.debit as balance 
from account_move_line aml
join account_move am on am.id=aml.move_id
join account_account aa on aa.id=aml.account_id
left join account_analytic_account aaa on aaa.id=aml.analytic_account_id
join account_account_type aatype on aatype.id=aa.user_type_id
where aml.company_id=1 and aml.date >= '2019-01-01' and aml.journal_id != 77 and 
   aa.id in (
      select distinct aaati.account_account_id from account_account_account_tag aaati 
         join account_account_tag aati on aati.id=aaati.account_account_tag_id 
         where left(aati.name,2)='pr')
order by am.name ;
*********************
